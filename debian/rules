#!/usr/bin/make -f

# SPDX-FileCopyrightText: 2024 DeepinScan Team
# SPDX-License-Identifier: LGPL-3.0-or-later

# Debian packaging rules for DeepinScan

export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DEB_CFLAGS_MAINT_APPEND  = -Wall -pedantic
export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed

# CMake build configuration
CMAKE_FLAGS = \
	-DCMAKE_BUILD_TYPE=Release \
	-DCMAKE_INSTALL_PREFIX=/usr \
	-DCMAKE_INSTALL_LIBDIR=lib \
	-DCMAKE_INSTALL_INCLUDEDIR=include \
	-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
	-DBUILD_SHARED_LIBS=ON \
	-DBUILD_TESTING=ON

%:
	dh $@ --buildsystem=cmake

override_dh_auto_configure:
	dh_auto_configure -- $(CMAKE_FLAGS)

override_dh_auto_build:
	dh_auto_build
	# Generate documentation if available
	if [ -f docs/Doxyfile ]; then \
		cd docs && doxygen Doxyfile; \
	fi

override_dh_auto_test:
	# Run test suite if available
	dh_auto_test || echo "Tests failed but continuing build"

override_dh_auto_install:
	dh_auto_install
	# Remove unnecessary files
	find debian/tmp -name "*.la" -delete
	# Install additional files
	install -D -m 644 debian/deepinscan.desktop \
		debian/deepinscan/usr/share/applications/deepinscan.desktop || true

override_dh_missing:
	dh_missing --fail-missing

override_dh_compress:
	dh_compress -X.pdf -X.svg

override_dh_strip:
	dh_strip --dbgsym-migration='deepinscan-dbg (<< 1.0.0)'

# Clean additional build artifacts
override_dh_auto_clean:
	dh_auto_clean
	rm -rf docs/html docs/latex || true
	rm -f test_results/* || true 